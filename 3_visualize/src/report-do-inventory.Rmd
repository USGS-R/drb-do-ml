---
title: "DRB dissolved oxygen data availability"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    keep_md: true
---

## Records summary  
  

### A Quick Look

```{r,echo=FALSE,message=FALSE,warning=FALSE}

options(scipen=999)

# Load WQP DO data:
DO_wqp_data <- tar_read(p2_filtered_wqp_data)

# Load full site list:
site_list_path <- tar_read(p2_site_list_csv)
site_list <- read_csv(site_list_path,show_col_types = FALSE)

# Summarize DO observation-days:
daily_days <- site_list %>% 
  filter(grepl("daily",data_src_combined)) %>%
  summarize(n_days = sum(n_obsdays_nwis))

inst_days <- site_list %>%
  filter(grepl("inst",data_src_combined)) %>%
  summarize(n_days = sum(n_obsdays_nwis))

# Load daily DO data:
daily_DO_data <- tar_read(p1_daily_data)

# Load continuous DO data:
inst_DO_data <- tar_read(p1_inst_data)
inst_DO_data <- inst_DO_data %>%
  mutate(Date = lubridate::date(dateTime))

# List out number of instantaneous sites by day, month, year:
inventory_inst <- inst_DO_data %>%
  mutate(Month = lubridate::month(dateTime),
         doy = lubridate::yday(dateTime),
         Year = lubridate::year(dateTime),
         doy_year = paste(doy,Year,sep="-")) %>%
  group_by(doy_year,doy,Year) %>%
  summarize(n_obs_inst = n(),
            n_sites_inst = length(unique(site_no)),
            .groups="keep")

# List out number of daily sites by day, month, year:
inventory_daily <- daily_DO_data %>%
  mutate(Month = lubridate::month(Date),
         doy = lubridate::yday(Date),
         Year = lubridate::year(Date),
         doy_year = paste(doy,Year,sep="-")) %>%
  group_by(doy_year,doy,Year) %>% 
  summarize(n_obs_daily = n(),
            n_sites_daily = length(unique(site_no)),
            .groups="keep") 

```

Dissolved oxygen data was pulled from NWIS (for continuous and daily data) as well as the Water Quality Portal, which focuses on discrete (snapshot) samples. Specifically, for the WQP, we used the harmonized multiscale surface water quality dataset for the Delaware River Basin ([Shoda et al. 2019](https://doi.org/10.5066/P9PX8LZO)). We're focused on dissolved oxygen reported in units of mg/L.  

For NWIS, there were `r length(site_list$site_id[grepl("NWIS",site_list$data_src_combined)])` continuous DO sites within the DRB. Some of those report the instantaneous values, but for older data only daily values were available. Here's a breakdown of the sites/samples:



| Site type                          | Number of unique sites                                                                  | Number of observation-days                           |
| ---------------------------------- | --------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| WQP                                | `r length(site_list$site_id[which(site_list$data_src_combined=="Harmonized_WQP_data")])`| `r sum(site_list$n_obsdays_discrete[which(site_list$data_src_combined=="Harmonized_WQP_data")])` |
| NWIS-instantaneous                 | `r length(site_list$site_id[grepl("inst",site_list$data_src_combined)])`               | `r sum(site_list$n_obsdays_nwis[grepl("inst",site_list$data_src_combined)])`                    |
| NWIS-daily only                    | `r length(site_list$site_id[grepl("daily",site_list$data_src_combined)])`                | `r sum(site_list$n_obsdays_nwis[grepl("daily",site_list$data_src_combined)])`                           |



<br>  


Combining the harmonized WQP dataset with data from NWIS (which includes data from NGWOS high-frequency stations), here is a map of site locations with dissolved oxygen data:  

```{r,echo=FALSE}

# Create spatial object:
site_list_sp <- sf::st_as_sf(site_list,coords=c("lon","lat"),crs=4269) %>%
  sf::st_transform(4326) %>%
  mutate(group = as.factor(case_when(data_src_combined == "NWIS_daily/Harmonized_WQP_data" ~ "daily",
                           data_src_combined == "NWIS_instantaneous/Harmonized_WQP_data" ~ "instantaneous",
                           data_src_combined == "Harmonized_WQP_data" ~ "discrete",
                           data_src_combined == "NWIS_instantaneous" ~ "instantaneous",
                           data_src_combined == "NWIS_daily" ~ "daily")))

# Define color palette for circle markers:
pal <- colorFactor(palette = c("blue","orange","green"),domain=site_list_sp$group)
  
# Plot sites:
leaflet() %>%
  addProviderTiles("CartoDB.DarkMatter", group = "CartoDB") %>%
  addCircleMarkers(data=site_list_sp,radius = ~sqrt(n_obsdays_total/40),color = ~pal(group),
    stroke = FALSE, fillOpacity = 0.5,popup=paste("Site:", site_list_sp$site_id,"<br>",
                                                  "n_observation-days:", site_list_sp$n_obsdays_total)) %>%
    addLegend("bottomright", colors = c("orange","green","blue"), labels = c("discrete","instantaneous","daily")) 

```

<br>  

For the WQP data, the number of DO records - as well as the number of different sites represented - picks up after ~2000.   

```{r,echo=FALSE}

DO_wqp_data %>% 
  group_by(ActivityStartDate) %>% 
  summarize(n_sites = length(unique(MonitoringLocationIdentifier))) %>% 
  mutate(Year = lubridate::year(ActivityStartDate),doy = lubridate::yday(ActivityStartDate)) %>% 
  ggplot() +
  geom_tile(aes(x=doy,y=Year,fill=n_sites)) + 
  scale_fill_gradient(low = "#eff3ff", high = "#08519c",trans="log",breaks= c(1,5,50)) + 
  theme_bw() + coord_cartesian(ylim=c(1950,2025))+
  theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank())

```

<br>

There is some seasonal bias to the NWIS continuous data, since some stations appear to pull their sensors over the winter:  

```{r,echo=FALSE}

inventory_inst %>% filter(Year != "2007") %>%
  ggplot() +
  geom_tile(aes(x=doy,y=Year,fill=n_sites_inst)) + 
  scale_fill_viridis_c()+
  theme_bw() + 
  theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank())


```


<br>  

